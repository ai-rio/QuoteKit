# Fly.io Optimized Configuration for QuoteKit
# Fixes: OOM kills, load balancing issues, health check failures
# Optimized for: Stability, Performance, Cost Efficiency

app = "quotekit-prelaunch-test"
primary_region = "iad"  # Washington, D.C. - chosen for low latency to Supabase
kill_signal = "SIGINT"
kill_timeout = "5s"

[experimental]
  auto_rollback = true

[build]
  [build.args]
    NEXT_PUBLIC_SUPABASE_URL = "https://bujajubcktlpblewxtel.supabase.co"
    NEXT_PUBLIC_SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ1amFqdWJja3RscGJsZXd4dGVsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ4NDMzNTQsImV4cCI6MjA3MDQxOTM1NH0.oLzfozz8_bYJrarlZyHJG3IM54AKLoIWI5D97TFwjH0"
    NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY = "pk_test_51PCRaPGgBK1ooXYFCVdD8Yr2O6moR1s5QzFRWopBmlsPBWHR2bLMvZ400elEJ3rzux9DNpnYadXJXnp0cqX7jmhv00c20JEgSB"
    NEXT_PUBLIC_POSTHOG_KEY = "phc_aTMaOPKid2gfZUqqSs2JjHQEBLOFBhQRJke8JbWF8ya"
    NEXT_PUBLIC_POSTHOG_HOST = "https://us.i.posthog.com"
    NEXT_PUBLIC_SITE_URL = "https://quotekit-prelaunch-test.fly.dev"
    SUPABASE_SERVICE_ROLE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ1amFqdWJja3RscGJsZXd4dGVsIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1NDg0MzM1NCwiZXhwIjoyMDcwNDE5MzU0fQ.pIsMT2ohSRtkLDWS57GGpQYQOL5SVtUd8gDyNtdKjS8"
    STRIPE_SECRET_KEY = "sk_test_51PCRaPGgBK1ooXYFpk09Mu8FvgQXshbm4XbpP0DZZ2crzJOabfqA60dUSQfg8yXWcs8IarbP8QAhQe4fhcwXp2M200b5lTZLuH"
    STRIPE_WEBHOOK_SECRET = "whsec_391ee7fb05561e9f61817d6a97d7fc7a673be11ea853af57fa144b11e551c2f7"
    RESEND_API_KEY = "re_3VoudbyM_3L7J7KjqXuzFr9SiKRAXXBDA"
    POSTHOG_PROJECT_API_KEY = "phc_aTMaOPKid2gfZUqqSs2JjHQEBLOFBhQRJke8JbWF8ya"
    POSTHOG_PROJECT_ID = "your-project-id"
    POSTHOG_PERSONAL_API_KEY = "your-personal-api-key"
    SUPABASE_DB_PASSWORD = "Luliflora1.@"

[env]
  # Application environment
  NODE_ENV = "production"
  PORT = "3000"
  
  # Next.js optimization - FIXED: Match actual memory allocation
  NODE_OPTIONS = "--max-old-space-size=1024"  # Allow Node.js to use more memory
  NEXT_TELEMETRY_DISABLED = "1"
  
  # Application configuration
  NEXT_PUBLIC_APP_ENV = "prelaunch-test"
  
  # Build-time configuration
  SKIP_INSTALL_DEPS = "false"
  NPM_CONFIG_PRODUCTION = "false"
  
  # Public environment variables (needed at build time)
  NEXT_PUBLIC_SUPABASE_URL = "https://bujajubcktlpblewxtel.supabase.co"
  NEXT_PUBLIC_SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ1amFqdWJja3RscGJsZXd4dGVsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ4NDMzNTQsImV4cCI6MjA3MDQxOTM1NH0.oLzfozz8_bYJrarlZyHJG3IM54AKLoIWI5D97TFwjH0"
  NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY = "pk_test_51PCRaPGgBK1ooXYFCVdD8Yr2O6moR1s5QzFRWopBmlsPBWHR2bLMvZ400elEJ3rzux9DNpnYadXJXnp0cqX7jmhv00c20JEgSB"
  NEXT_PUBLIC_POSTHOG_KEY = "phc_aTMaOPKid2gfZUqqSs2JjHQEBLOFBhQRJke8JbWF8ya"
  NEXT_PUBLIC_POSTHOG_HOST = "https://us.i.posthog.com"
  NEXT_PUBLIC_SITE_URL = "https://quotekit-prelaunch-test.fly.dev"

[deploy]
  # Deployment strategy - OPTIMIZED
  strategy = "rolling"  # Zero-downtime deployment
  wait_timeout = "10m"  # Allow time for build and startup

[processes]
  web = "node server.js"

# MODERN HTTP SERVICE CONFIGURATION - FIXED
[http_service]
  internal_port = 3000
  force_https = true
  # STABILITY FIXES:
  auto_stop_machines = "stop"  # Cost optimization
  auto_start_machines = true
  min_machines_running = 1     # CHANGED: Keep 1 running for availability
  
  # LOAD BALANCING CONFIGURATION - NEW
  [http_service.concurrency]
    type = "requests"
    hard_limit = 50      # Maximum concurrent requests per machine
    soft_limit = 25      # Fly Proxy uses this for load balancing decisions

  # OPTIMIZED HEALTH CHECKS - FIXED
  [http_service.checks]
    interval = "15s"     # REDUCED: Less frequent checks
    timeout = "5s"       # Reasonable timeout
    grace_period = "15s" # INCREASED: More time for startup
    method = "GET"
    path = "/api/health"
    protocol = "http"
    
    [http_service.checks.headers]
      User-Agent = "Fly.io Health Check"

# Metrics and monitoring
[metrics]
  port = 9091
  path = "/metrics"

# REMOVED CONFLICTING VM SECTION - This was causing memory conflicts

# Environment-specific build configuration
[build.env]
  NODE_ENV = "production"
  NEXT_BUILD_ID = "prelaunch-test"
  ANALYZE = "false"  # Disable bundle analyzer in test builds
  
  # Environment variables needed at build time
  NEXT_PUBLIC_SUPABASE_URL = "https://bujajubcktlpblewxtel.supabase.co"
  NEXT_PUBLIC_SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ1amFqdWJja3RscGJsZXd4dGVsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ4NDMzNTQsImV4cCI6MjA3MDQxOTM1NH0.oLzfozz8_bYJrarlZyHJG3IM54AKLoIWI5D97TFwjH0"
  NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY = "pk_test_51PCRaPGgBK1ooXYFCVdD8Yr2O6moR1s5QzFRWopBmlsPBWHR2bLMvZ400elEJ3rzux9DNpnYadXJXnp0cqX7jmhv00c20JEgSB"
  NEXT_PUBLIC_POSTHOG_KEY = "phc_aTMaOPKid2gfZUqqSs2JjHQEBLOFBhQRJke8JbWF8ya"
  NEXT_PUBLIC_POSTHOG_HOST = "https://us.i.posthog.com"
  NEXT_PUBLIC_SITE_URL = "https://quotekit-prelaunch-test.fly.dev"
  
  # Server-side secrets needed for build (but will be overridden at runtime by secrets)
  SUPABASE_SERVICE_ROLE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ1amFqdWJja3RscGJsZXd4dGVsIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1NDg0MzM1NCwiZXhwIjoyMDcwNDE5MzU0fQ.pIsMT2ohSRtkLDWS57GGpQYQOL5SVtUd8gDyNtdKjS8"
  STRIPE_SECRET_KEY = "sk_test_51PCRaPGgBK1ooXYFpk09Mu8FvgQXshbm4XbpP0DZZ2crzJOabfqA60dUSQfg8yXWcs8IarbP8QAhQe4fhcwXp2M200b5lTZLuH"
  STRIPE_WEBHOOK_SECRET = "whsec_391ee7fb05561e9f61817d6a97d7fc7a673be11ea853af57fa144b11e551c2f7"
  RESEND_API_KEY = "re_3VoudbyM_3L7J7KjqXuzFr9SiKRAXXBDA"
  POSTHOG_PROJECT_API_KEY = "phc_aTMaOPKid2gfZUqqSs2JjHQEBLOFBhQRJke8JbWF8ya"
  POSTHOG_PROJECT_ID = "your-project-id"
  POSTHOG_PERSONAL_API_KEY = "your-personal-api-key"
  SUPABASE_DB_PASSWORD = "Luliflora1.@"

# Security and network configuration
[network]
  # Enable IPv6
  ipv6 = true

# SIMPLIFIED HEADERS - Removed complex CSP that might cause issues
[[headers]]
  for = "/*"
  
  [headers.values]
    X-Environment = "prelaunch-test"
    X-Robots-Tag = "noindex, nofollow"  # Prevent search engine indexing
    X-Frame-Options = "DENY"
    X-Content-Type-Options = "nosniff"
    Referrer-Policy = "strict-origin-when-cross-origin"
