# üß™ S2.1 B2B2C Payment System - Test Plan

**Date**: August 26, 2025  
**Feature**: S2.1 Homeowner Invoice System  
**Status**: Ready for Testing  

## üéØ Test Overview

The S2.1 B2B2C Payment System allows lawn care companies to send invoices directly to homeowners using Stripe's Customer Portal. This creates a seamless payment experience where:

1. **Lawn Care Company** creates quote in QuoteKit
2. **System** generates Stripe invoice for homeowner
3. **Homeowner** receives email with payment portal link
4. **Stripe Portal** handles payment processing
5. **Company** receives payment notification

## üîß Prerequisites

### **Environment Setup**
- ‚úÖ Next.js development server running
- ‚úÖ Supabase connection active
- ‚úÖ Stripe test keys configured
- ‚úÖ Valid test quote data in database

### **Required Test Data**
```sql
-- Ensure you have a test quote with property relationship
SELECT q.id, q.quote_number, q.total, q.client_name,
       p.service_address, p.property_name
FROM quotes q
LEFT JOIN properties p ON q.property_id = p.id
WHERE q.user_id = '[YOUR_USER_ID]'
LIMIT 1;
```

### **Stripe Test Environment**
- Use Stripe test mode (keys starting with `pk_test_` and `sk_test_`)
- Test email addresses (use your own email for testing)
- Stripe webhook endpoints configured for local testing

## üß™ Test Scenarios

### **Test 1: Basic Invoice Creation** ‚≠ê **CRITICAL**

**Objective**: Verify basic homeowner invoice creation and email delivery

**Steps**:
1. Navigate to a quote details page
2. Locate the "QuotePaymentStatus" component
3. Enter test homeowner email: `test-homeowner@example.com`
4. Enter homeowner name: `John Homeowner`
5. Set payment terms: `30` days
6. Click "Send Invoice to Homeowner"

**Expected Results**:
- ‚úÖ Success toast: "Invoice sent successfully!"
- ‚úÖ Stripe Customer created for homeowner
- ‚úÖ Stripe Invoice generated with quote details
- ‚úÖ Email sent to homeowner with payment link
- ‚úÖ Quote status updated in database

**Validation**:
```bash
# Check Stripe Dashboard
# - New customer with homeowner email
# - New invoice with quote amount
# - Invoice status: "open"

# Check database
SELECT stripe_invoice_id, stripe_customer_id, invoice_status, homeowner_email
FROM quotes WHERE id = '[QUOTE_ID]';
```

### **Test 2: Email Validation** ‚≠ê **CRITICAL**

**Objective**: Verify email validation prevents invalid addresses

**Test Cases**:
| Input | Expected Result |
|-------|----------------|
| `invalid-email` | ‚ùå Error: "Please enter a valid email address" |
| `test@` | ‚ùå Error: "Please enter a valid email address" |
| `@example.com` | ‚ùå Error: "Please enter a valid email address" |
| `` (empty) | ‚ùå Error: "Please enter a homeowner email address" |
| `valid@example.com` | ‚úÖ Success |

### **Test 3: Payment Terms Validation**

**Objective**: Verify payment terms validation and defaults

**Test Cases**:
| Input | Expected Result |
|-------|----------------|
| `0` | ‚úÖ Due immediately |
| `30` | ‚úÖ Due in 30 days |
| `365` | ‚úÖ Due in 1 year |
| `-5` | ‚úÖ Defaults to 30 days |
| `abc` | ‚úÖ Defaults to 30 days |
| `` (empty) | ‚úÖ Defaults to 30 days |

### **Test 4: Homeowner Portal Access** ‚≠ê **CRITICAL**

**Objective**: Test homeowner payment portal functionality

**Steps**:
1. Create invoice for homeowner (Test 1)
2. Copy the `hosted_invoice_url` from Stripe response
3. Open URL in incognito browser window
4. Verify Stripe Customer Portal loads
5. Test payment flow with Stripe test cards

**Expected Results**:
- ‚úÖ Professional payment portal loads
- ‚úÖ Quote details displayed correctly
- ‚úÖ Payment methods available (card, ACH if enabled)
- ‚úÖ Test payment processes successfully
- ‚úÖ Receipt generated and emailed

**Test Cards**:
```
Success: 4242424242424242
Decline: 4000000000000002
Insufficient Funds: 4000000000009995
```

### **Test 5: Portal Session Management**

**Objective**: Test portal session creation for existing customers

**Steps**:
1. Create invoice for homeowner (creates Stripe Customer)
2. Use "Open Payment Portal" button
3. Verify portal session creation
4. Test portal functionality

**Expected Results**:
- ‚úÖ Portal session created successfully
- ‚úÖ Homeowner can access payment history
- ‚úÖ Payment methods can be updated
- ‚úÖ Return URL works correctly

### **Test 6: Error Handling** ‚≠ê **CRITICAL**

**Objective**: Verify proper error handling for various failure scenarios

**Test Cases**:

**6.1 Invalid Quote ID**:
```typescript
// Manually test with non-existent quote ID
createHomeownerInvoice({
  quoteId: 'non-existent-id',
  homeownerEmail: 'test@example.com'
});
// Expected: Error message about quote not found
```

**6.2 Stripe API Failure**:
- Temporarily use invalid Stripe keys
- Expected: Proper error handling and user feedback

**6.3 Database Connection Issues**:
- Test with Supabase connection issues
- Expected: Graceful error handling

### **Test 7: Webhook Integration** ‚≠ê **CRITICAL**

**Objective**: Verify webhook handling for payment events

**Setup**:
1. Configure Stripe webhook endpoint: `/api/webhooks/stripe`
2. Enable events: `invoice.payment_succeeded`, `invoice.payment_failed`

**Test Steps**:
1. Create homeowner invoice
2. Process test payment through portal
3. Verify webhook receives payment event
4. Check quote status update in database

**Expected Results**:
- ‚úÖ Webhook receives `invoice.payment_succeeded`
- ‚úÖ Quote status updated to "paid"
- ‚úÖ Payment timestamp recorded
- ‚úÖ Homeowner payment record created

### **Test 8: UI/UX Validation**

**Objective**: Verify user interface and experience quality

**Checklist**:
- ‚úÖ Component renders without errors
- ‚úÖ Form validation provides clear feedback
- ‚úÖ Loading states display during API calls
- ‚úÖ Success/error messages are user-friendly
- ‚úÖ Mobile responsive design works
- ‚úÖ Accessibility standards met (ARIA labels, keyboard navigation)

### **Test 9: Integration with Quote System**

**Objective**: Verify seamless integration with existing quote workflow

**Test Steps**:
1. Create new quote through normal workflow
2. Navigate to quote details
3. Verify QuotePaymentStatus component appears
4. Test invoice creation from quote context
5. Verify quote data flows correctly to Stripe

**Expected Results**:
- ‚úÖ Component integrates seamlessly
- ‚úÖ Quote data (amount, description, client info) transfers correctly
- ‚úÖ Property address included in invoice description
- ‚úÖ Company branding applied to invoice

### **Test 10: Performance & Scalability**

**Objective**: Verify system performance under load

**Test Cases**:
- Create multiple invoices rapidly
- Test with large quote amounts
- Verify database query performance
- Check Stripe API rate limiting handling

## üîç Manual Testing Checklist

### **Pre-Testing Setup**
- [ ] Development server running on localhost:3000
- [ ] Stripe test mode enabled
- [ ] Test email account accessible
- [ ] Database has test quote data
- [ ] Supabase connection verified

### **Core Functionality**
- [ ] Invoice creation works end-to-end
- [ ] Email validation prevents invalid addresses
- [ ] Payment terms validation works correctly
- [ ] Homeowner portal loads and functions
- [ ] Payment processing completes successfully
- [ ] Webhook events update quote status

### **Error Scenarios**
- [ ] Invalid inputs handled gracefully
- [ ] Network errors display user-friendly messages
- [ ] Stripe API errors handled properly
- [ ] Database errors don't crash application

### **UI/UX Quality**
- [ ] Component renders correctly
- [ ] Loading states provide feedback
- [ ] Success/error messages are clear
- [ ] Mobile responsive design verified
- [ ] Accessibility standards met

## üö® Critical Test Points

### **Must Pass Before Production**:
1. **End-to-End Invoice Flow** - Complete workflow from quote to payment
2. **Email Delivery** - Homeowners receive invoice emails
3. **Payment Processing** - Stripe portal processes payments correctly
4. **Webhook Integration** - Payment events update quote status
5. **Error Handling** - All error scenarios handled gracefully

### **Security Validation**:
- [ ] Only authenticated users can create invoices
- [ ] Quote ownership verified before invoice creation
- [ ] Homeowner data properly validated and sanitized
- [ ] Stripe API keys secured and not exposed

## üìä Test Results Template

```markdown
## Test Execution Results

**Date**: [DATE]
**Tester**: [NAME]
**Environment**: [LOCAL/STAGING/PRODUCTION]

### Test Results Summary
- **Total Tests**: 10
- **Passed**: ___
- **Failed**: ___
- **Blocked**: ___

### Failed Tests
| Test | Issue | Severity | Notes |
|------|-------|----------|-------|
| | | | |

### Recommendations
- [ ] Ready for production deployment
- [ ] Requires fixes before deployment
- [ ] Additional testing needed

**Overall Status**: ‚úÖ PASS / ‚ùå FAIL / ‚ö†Ô∏è CONDITIONAL
```

## üîß Debugging Tools

### **Useful Commands**:
```bash
# Check Stripe webhook events
stripe listen --forward-to localhost:3000/api/webhooks/stripe

# Monitor database changes
supabase db logs --follow

# Check Next.js logs
npm run dev

# Validate TypeScript
npm run type-check
```

### **Database Queries**:
```sql
-- Check quote payment status
SELECT id, quote_number, stripe_invoice_id, invoice_status, homeowner_email
FROM quotes WHERE stripe_invoice_id IS NOT NULL;

-- Check homeowner payments
SELECT * FROM homeowner_payments ORDER BY created_at DESC LIMIT 10;
```

---

**Ready to test S2.1 B2B2C Payment System!** üöÄ

Start with Test 1 (Basic Invoice Creation) and work through the checklist systematically.
