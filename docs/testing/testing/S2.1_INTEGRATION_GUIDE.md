# 🔧 S2.1 QuotePaymentStatus Integration Guide

## Current Status
The S2.1 B2B2C Payment System components are implemented but **not yet integrated** into the quote details page.

## Required Integration

### 1. Add QuotePaymentStatus to QuoteViewer

**File**: `src/features/quotes/components/QuoteViewer.tsx`

**Add import**:
```typescript
import { QuotePaymentStatus } from './QuotePaymentStatus';
```

**Add component after quote details section** (around line 200):
```typescript
{/* B2B2C Payment Section */}
<div className="mt-8">
  <QuotePaymentStatus 
    quote={quote} 
    onStatusUpdate={() => {
      // Optionally refresh quote data
      window.location.reload();
    }} 
  />
</div>
```

### 2. Update Quote Type (if needed)

The QuotePaymentStatus component expects these fields on the quote object:
- `homeowner_email?: string`
- `homeowner_name?: string`
- `payment_terms?: number`
- `stripe_invoice_id?: string`
- `stripe_customer_id?: string`
- `invoice_status?: string`

These should already be available from the database migration.

## Quick Integration Script

Run this to integrate automatically:

```bash
# Make the test script executable
chmod +x scripts/test-s2-1.js

# Run the validation test
node scripts/test-s2-1.js
```

## Manual Testing Steps

1. **Start the development server**:
   ```bash
   npm run dev
   ```

2. **Navigate to any quote details page**:
   ```
   http://localhost:3000/quotes/[quote-id]
   ```

3. **Look for the QuotePaymentStatus component**:
   - Should appear below the quote details
   - Contains form fields for homeowner email/name
   - Has "Send Invoice to Homeowner" button

4. **Test the invoice creation**:
   - Enter a test email address
   - Click "Send Invoice to Homeowner"
   - Check for success toast message
   - Verify Stripe dashboard for new customer/invoice

## Expected UI Location

The QuotePaymentStatus component should appear in the quote details page as a card section with:

```
┌─────────────────────────────────────┐
│ Quote Details                       │
│ [Quote information...]              │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│ 💳 Homeowner Payment                │
│                                     │
│ Email: [________________]           │
│ Name:  [________________]           │
│ Terms: [30 days ▼]                  │
│                                     │
│ [Send Invoice to Homeowner]         │
└─────────────────────────────────────┘
```

## Troubleshooting

### Component Not Appearing
- Check if QuotePaymentStatus is imported in QuoteViewer.tsx
- Verify the component is added to the JSX
- Check browser console for errors

### TypeScript Errors
- Ensure quote type includes B2B2C fields
- Check import paths are correct
- Run `npm run type-check`

### Database Errors
- Verify migration was applied: `supabase migration up`
- Check if B2B2C columns exist in quotes table
- Verify RLS policies allow access

## Next Steps After Integration

1. Test the complete workflow end-to-end
2. Verify Stripe webhook integration
3. Test payment portal functionality
4. Validate email delivery
5. Check payment status updates

---

**Status**: Ready for integration and testing 🚀
