# Fly.io SECURE Configuration for QuoteKit
# ðŸ”’ SECURITY HARDENED - All secrets managed via `fly secrets set`
# âœ… Zero hardcoded credentials
# âœ… Optimized for stability, performance, and security

app = "quotekit-prelaunch-test"
primary_region = "iad"  # Washington, D.C. - chosen for low latency to Supabase
kill_signal = "SIGINT"
kill_timeout = "5s"

[experimental]
  auto_rollback = true

[build]
  # ðŸ”’ SECURITY: Only public keys in build args - all secrets managed via `fly secrets`
  [build.args]
    NEXT_PUBLIC_SUPABASE_URL = "https://bujajubcktlpblewxtel.supabase.co"
    NEXT_PUBLIC_SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ1amFqdWJja3RscGJsZXd4dGVsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ4NDMzNTQsImV4cCI6MjA3MDQxOTM1NH0.oLzfozz8_bYJrarlZyHJG3IM54AKLoIWI5D97TFwjH0"
    NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY = "pk_test_51PCRaPGgBK1ooXYFCVdD8Yr2O6moR1s5QzFRWopBmlsPBWHR2bLMvZ400elEJ3rzux9DNpnYadXJXnp0cqX7jmhv00c20JEgSB"
    NEXT_PUBLIC_POSTHOG_KEY = "phc_aTMaOPKid2gfZUqqSs2JjHQEBLOFBhQRJke8JbWF8ya"
    NEXT_PUBLIC_POSTHOG_HOST = "https://us.i.posthog.com"
    NEXT_PUBLIC_SITE_URL = "https://quotekit-prelaunch-test.fly.dev"

[env]
  # Application environment
  NODE_ENV = "production"
  PORT = "3000"
  
  # Next.js optimization - FIXED: Match actual memory allocation
  NODE_OPTIONS = "--max-old-space-size=1024"  # Allow Node.js to use more memory
  NEXT_TELEMETRY_DISABLED = "1"
  
  # Application configuration
  NEXT_PUBLIC_APP_ENV = "prelaunch-test"
  
  # Build-time configuration
  SKIP_INSTALL_DEPS = "false"
  NPM_CONFIG_PRODUCTION = "false"
  
  # Public environment variables (safe to expose)
  NEXT_PUBLIC_SUPABASE_URL = "https://bujajubcktlpblewxtel.supabase.co"
  NEXT_PUBLIC_SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ1amFqdWJja3RscGJsZXd4dGVsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ4NDMzNTQsImV4cCI6MjA3MDQxOTM1NH0.oLzfozz8_bYJrarlZyHJG3IM54AKLoIWI5D97TFwjH0"
  NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY = "pk_test_51PCRaPGgBK1ooXYFCVdD8Yr2O6moR1s5QzFRWopBmlsPBWHR2bLMvZ400elEJ3rzux9DNpnYadXJXnp0cqX7jmhv00c20JEgSB"
  NEXT_PUBLIC_POSTHOG_KEY = "phc_aTMaOPKid2gfZUqqSs2JjHQEBLOFBhQRJke8JbWF8ya"
  NEXT_PUBLIC_POSTHOG_HOST = "https://us.i.posthog.com"
  NEXT_PUBLIC_SITE_URL = "https://quotekit-prelaunch-test.fly.dev"

# ðŸ”’ CRITICAL SECURITY NOTICE:
# ALL SENSITIVE SECRETS MUST BE SET VIA: `fly secrets set KEY=VALUE`
#
# Required secrets to set:
# fly secrets set SUPABASE_SERVICE_ROLE_KEY="your_service_role_key"
# fly secrets set STRIPE_SECRET_KEY="your_stripe_secret_key"
# fly secrets set STRIPE_WEBHOOK_SECRET="your_webhook_secret"
# fly secrets set RESEND_API_KEY="your_resend_api_key"
# fly secrets set POSTHOG_PROJECT_API_KEY="your_posthog_project_api_key"
# fly secrets set POSTHOG_PROJECT_ID="your_project_id"
# fly secrets set POSTHOG_PERSONAL_API_KEY="your_personal_api_key"
# fly secrets set SUPABASE_DB_PASSWORD="your_db_password"
# fly secrets set GOOGLE_CLIENT_ID="your_google_client_id"
# fly secrets set GOOGLE_CLIENT_SECRET="your_google_client_secret"

[deploy]
  # Deployment strategy - OPTIMIZED
  strategy = "rolling"  # Zero-downtime deployment
  wait_timeout = "10m"  # Allow time for build and startup

[processes]
  web = "node server.js"

# MODERN HTTP SERVICE CONFIGURATION - FIXED
[http_service]
  internal_port = 3000
  force_https = true
  processes = ["web"]
  # STABILITY FIXES:
  auto_stop_machines = "stop"  # Cost optimization
  auto_start_machines = true
  min_machines_running = 1     # Keep 1 running for availability
  
  # LOAD BALANCING CONFIGURATION
  [http_service.concurrency]
    type = "requests"
    hard_limit = 50      # Maximum concurrent requests per machine
    soft_limit = 25      # Fly Proxy uses this for load balancing decisions

  # OPTIMIZED HEALTH CHECKS
  [[http_service.checks]]
    interval = "15s"     # Reasonable frequency
    timeout = "5s"       # Reasonable timeout
    grace_period = "15s" # Time for startup
    method = "GET"
    path = "/api/health"
    protocol = "http"
    
    [http_service.checks.headers]
      User-Agent = "Fly.io Health Check"

# Metrics and monitoring
[metrics]
  port = 9091
  path = "/metrics"

# Environment-specific build configuration
[build.env]
  NODE_ENV = "production"
  NEXT_BUILD_ID = "prelaunch-test"
  ANALYZE = "false"  # Disable bundle analyzer in test builds
  
  # Public environment variables (safe for build time)
  NEXT_PUBLIC_SUPABASE_URL = "https://bujajubcktlpblewxtel.supabase.co"
  NEXT_PUBLIC_SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ1amFqdWJja3RscGJsZXd4dGVsIiwicm9sZUI6ImFub24iLCJpYXQiOjE3NTQ4NDMzNTQsImV4cCI6MjA3MDQxOTM1NH0.oLzfozz8_bYJrarlZyHJG3IM54AKLoIWI5D97TFwjH0"
  NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY = "pk_test_51PCRaPGgBK1ooXYFCVdD8Yr2O6moR1s5QzFRWopBmlsPBWHR2bLMvZ400elEJ3rzux9DNpnYadXJXnp0cqX7jmhv00c20JEgSB"
  NEXT_PUBLIC_POSTHOG_KEY = "phc_aTMaOPKid2gfZUqqSs2JjHQEBLOFBhQRJke8JbWF8ya"
  NEXT_PUBLIC_POSTHOG_HOST = "https://us.i.posthog.com"
  NEXT_PUBLIC_SITE_URL = "https://quotekit-prelaunch-test.fly.dev"

# Security and network configuration
[network]
  # Enable IPv6
  ipv6 = true

# ENHANCED SECURITY HEADERS
[[headers]]
  for = "/*"
  
  [headers.values]
    X-Environment = "prelaunch-test"
    X-Robots-Tag = "noindex, nofollow"  # Prevent search engine indexing
    X-Frame-Options = "DENY"
    X-Content-Type-Options = "nosniff"
    X-XSS-Protection = "1; mode=block"
    Referrer-Policy = "strict-origin-when-cross-origin"
    Permissions-Policy = "camera=(), microphone=(), geolocation=(), payment=()"
    Strict-Transport-Security = "max-age=31536000; includeSubDomains; preload"
    
    # Content Security Policy - Enhanced
    Content-Security-Policy = """
      default-src 'self';
      script-src 'self' 'unsafe-eval' 'unsafe-inline' https://js.stripe.com https://m.stripe.network;
      style-src 'self' 'unsafe-inline';
      connect-src 'self' 
                  https://api.stripe.com 
                  https://m.stripe.network 
                  https://hcaptcha.com 
                  https://*.hcaptcha.com 
                  https://vitals.vercel-insights.com 
                  wss://ws-us3.pusher.com
                  https://*.supabase.co
                  https://app.posthog.com
                  https://us.i.posthog.com
                  data:;
      img-src 'self' data: https: blob:;
      font-src 'self' data:;
      media-src 'self' blob:;
      worker-src 'self' blob:;
      frame-src https://js.stripe.com https://hooks.stripe.com;
      base-uri 'self';
      form-action 'self';
      frame-ancestors 'none';
    """